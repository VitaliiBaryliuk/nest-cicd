name: 'Validate nestjs-cicd'

trigger: []

pr:
  autoCancel: true
  branches:
    include:
      - 'develop'
  paths:
    exclude:
      - README.md

resources:
  repositories:
  - repository: templates
    type: github
    name: VitaliiBaryliuk/nest-cicd
    ref: refs/heads/develop
    endpoint: VitaliiBaryliuk
    allowScriptsAuthAccessOption: true

variables:
  System.Debug: true    

stages:
- stage: dev_stage_validate
  displayName: 'Run Validation Steps'
  jobs:
    - deployment: "dev_validate_job"
      pool:
        name: 'SelfHostedPool'
      environment: dev_validation
      strategy:
        runOnce:
          deploy:
            steps:
              - checkout: self
                path: $(System.DefaultWorkingDirectory)/self-repo
              - checkout: templates
                path: $(System.DefaultWorkingDirectory)/templates-repo

              - script: dir $(System.DefaultWorkingDirectory)/self-repo /s
                displayName: "Debug Workspace Contents (Self Repo)"

              - script: npm ci
                workingDirectory: $(System.DefaultWorkingDirectory)\self-repo
                displayName: "üç≥ Install Dependencies"

              - script: npm run lint
                workingDirectory: $(System.DefaultWorkingDirectory)\self-repo
                displayName: "üßê Lint"

              - script: npm run test
                workingDirectory: $(System.DefaultWorkingDirectory)\self-repo
                displayName: "üß™ Test"

              - script: npm run build
                workingDirectory: $(System.DefaultWorkingDirectory)\self-repo
                displayName: "üèóÔ∏è Build"