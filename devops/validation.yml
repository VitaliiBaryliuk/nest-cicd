name: 'Validate nestjs-cicd'

trigger:
  batch: true
  branches:
    include:
    - develop
  paths:
    exclude:
    - README.md

pr:
  autoCancel: false
  branches:
    include:
    - develop
  paths:
    exclude:
    - README.md

resources:
  repositories:
  - repository: templates
    type: github
    name: VitaliiBaryliuk/nest-cicd
    ref: refs/heads/develop
    endpoint: VitaliiBaryliuk

stages:
- stage: dev_stage_validate
  displayName: 'build deploy infrastructure'
  jobs:
    - deployment: "dev_validate_job"
      pool:
        vmImage: $(vmImageUbuntu)
      environment: dev_validation
      strategy:
        runOnce:
          deploy:
            steps:
            - checkout: self
            - checkout: templates
              clean: true
              fetchDepth: 5

            - script: npm ci
              workingDirectory: $(System.DefaultWorkingDirectory)/gateway-service
              displayName: '🍳 Install Dependencies'
            - script: npm run lint
              workingDirectory: $(System.DefaultWorkingDirectory)/gateway-service
              displayName: '🧐 Lint'
            - script: npm run test
              workingDirectory: $(System.DefaultWorkingDirectory)/gateway-service
              displayName: '🧪 Test'
            - script: npm run build
              workingDirectory: $(System.DefaultWorkingDirectory)/gateway-service
              displayName: '🏗️ Build'